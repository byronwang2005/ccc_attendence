<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="UNNC中国文化课签到二维码生成器 - 快速生成签到二维码">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#0f2437">
    <meta http-equiv="Cache-Control" content="max-age=31536000, public">
    <title>UNNC中国文化课签到二维码生成器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preload" href="ccc-small.webp" as="image" type="image/webp">
    <link rel="icon" type="image/svg" href="favicon.svg">
  <style>
    :root {
      --theme: #0f2437;
      --theme-dark: #0b1c2b;
      --accent: #2bb3af;
      --accent-dark: #219892;
      --accent-soft: rgba(43, 179, 175, 0.18);
      --accent-15: rgba(43, 179, 175, 0.15);
      --accent-26: rgba(43, 179, 175, 0.26);
      --accent-35: rgba(43, 179, 175, 0.35);
      --accent-50: rgba(43, 179, 175, 0.5);
      --bg-offwhite: #f7f4ef;
      --bg-top: #fbf9f5;
      --bg-bottom: #efe7dc;
      --brand-glow: rgba(43, 179, 175, 0.3);
      --theme-20: #cfd4d8;
      --theme-04: rgba(16, 38, 59, 0.04);
      --theme-08: rgba(16, 38, 59, 0.08);
      --theme-12: rgba(16, 38, 59, 0.12);
      --theme-14: rgba(16, 38, 59, 0.14);
      --theme-15: rgba(16, 38, 59, 0.15);
      --theme-20a: rgba(16, 38, 59, 0.2);
      --theme-28: rgba(16, 38, 59, 0.28);
      --accent-20: #d3eeed;
      --accent-light-90: rgba(211, 238, 237, 0.9);
      --white: #ffffff;
      --white-10: rgba(255, 255, 255, 0.1);
      --white-40: rgba(255, 255, 255, 0.4);
      --white-70: rgba(255, 255, 255, 0.7);
      --white-85: rgba(255, 255, 255, 0.85);
      --white-60: rgba(255, 255, 255, 0.6);
      --white-0: rgba(255, 255, 255, 0);
      --transparent: rgba(0, 0, 0, 0);
      --dark-bg: #10263B;
      --light-text: #d7f0ef;
      --text-muted: #cfd4d8;
      --text-secondary: #4f6474;
      --shadow: rgba(16, 38, 59, 0.08);
      --shadow-strong: rgba(16, 38, 59, 0.14);
      --danger: #dc2626;
      --transition-fast: 0.15s;
      --transition-normal: 0.2s;
      --transition-slow: 0.3s;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 8% -12%, var(--accent-15), var(--transparent) 60%), radial-gradient(900px 500px at 90% 8%, var(--accent-soft), var(--transparent) 60%), linear-gradient(180deg, var(--bg-top) 0%, var(--bg-offwhite) 40%, var(--bg-bottom) 100%);
      color: var(--theme);
      padding: 24px;
      max-width: 820px;
      margin: 0 auto;
      min-height: 100vh;
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    
    header {
      text-align: center;
      margin: 32px 0 24px;
      position: relative;
    }

    main {
      display: grid;
      gap: 18px;
    }

    h1 {
      font-weight: 700;
      font-size: 28px;
      color: var(--theme);
      display: inline-flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      line-height: 1.2;
    }

    .brand-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--theme-08);
      color: var(--theme);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      box-shadow: 0 6px 14px var(--theme-08);
    }

    .brand-subtitle {
      margin-top: 10px;
      font-size: 15px;
      color: var(--text-secondary);
    }

    h1 .logo {
      vertical-align: middle;
    }

    .logo {
      height: 88px;
      width: auto;
      filter: drop-shadow(0 8px 20px var(--theme-15));
      animation: float 6s ease-in-out infinite;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 26px;
      margin: 0;
      box-shadow: 0 14px 30px var(--shadow);
      border: 1px solid var(--theme-08);
    }

    @media (hover: hover) {
      .motion-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px var(--theme-12);
        border-color: var(--theme-20a);
      }
    }

    .motion-card {
      transition: transform var(--transition-normal), box-shadow var(--transition-normal), border-color var(--transition-normal), background var(--transition-normal);
    }
    
    .card h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--theme);
    }
    
    textarea, input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--theme-12);
      border-radius: var(--radius-lg);
      font-size: 15px;
      font-family: inherit;
      background: var(--white);
      resize: none;
      outline: none;
      transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
    }

    textarea:hover, input[type="number"]:hover {
      border-color: var(--theme-28);
    }
    
    textarea:focus, input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-20), 0 8px 18px var(--shadow);
    }

    textarea:focus-visible, input[type="number"]:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    textarea { min-height: 72px; }

    .help-text {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 8px;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--theme-08);
      background: var(--white);
      transition: border-color var(--transition-normal), box-shadow var(--transition-normal), transform var(--transition-fast);
    }

    .radio-option:focus-within {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
      border-radius: var(--radius-md);
    }
    
    .radio-option input {
      width: auto;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    .time-input {
      display: none;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 18px;
    }
    
    .time-input.show {
      display: grid;
    }
    
    .time-input label {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      display: block;
      margin-bottom: 4px;
    }
    
    .time-input input {
      text-align: center;
      padding: 10px 0;
    }
    
    .btn-primary {
      background: linear-gradient(180deg, var(--theme) 0%, var(--theme-dark) 100%);
      color: var(--white);
      border: none;
      padding: 14px;
      border-radius: var(--radius-lg);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
      box-shadow: 0 12px 22px var(--theme-14);
      position: relative;
      overflow: hidden;
      transition: background var(--transition-normal), transform var(--transition-fast), opacity var(--transition-normal), box-shadow var(--transition-normal);
    }

    .btn-primary::after {
      content: "";
      position: absolute;
      inset: -40% auto auto -30%;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, var(--white-40), var(--white-0) 60%);
      transform: translateX(-60%);
      opacity: 0;
      transition: transform var(--transition-slow), opacity var(--transition-normal);
      pointer-events: none;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(180deg, var(--theme-dark) 0%, #081423 100%);
      box-shadow: 0 14px 28px var(--theme-20a);
    }

    .btn-primary:hover:not(:disabled)::after {
      transform: translateX(60%);
      opacity: 1;
    }
    
    .btn-primary:active:not(:disabled) {
      transform: scale(0.99);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    #qrcode {
      display: flex;
      justify-content: center;
      margin: 24px 0 16px;
      min-height: 230px;
      align-items: center;
      background: linear-gradient(180deg, var(--white), var(--white-70));
      border: 1px dashed var(--theme-15);
      border-radius: var(--radius-xl);
    }
    
    #qrcode canvas, #qrcode img {
      background: var(--theme);
      border-radius: var(--radius-xl);
      padding: 18px;
      box-shadow: 0 6px 16px var(--shadow-strong);
    }

    .qrcode-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      font-size: 14px;
      text-align: center;
      padding: 12px;
    }

    .qrcode-placeholder small {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--theme-20);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .note {
      background: linear-gradient(180deg, var(--accent-light-90), var(--white-85));
      border: 1px solid var(--accent-35);
      border-radius: var(--radius-xl);
      padding: 22px;
      font-size: 14px;
      color: var(--theme);
      line-height: 1.5;
      box-shadow: 0 14px 32px var(--theme-12);
    }

    .hero-card {
      position: relative;
      overflow: hidden;
    }

    .hero-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--brand-glow) 0%, var(--accent-26) 40%, var(--white-10) 75%, var(--white-0) 100%);
      background-size: 200% 100%;
      background-position: 50% 0;
      opacity: 0;
      transition: opacity var(--transition-slow), background-position var(--transition-slow);
      pointer-events: none;
    }

    .hero-card.is-human::before {
      opacity: 1;
      background-position: 0% 0;
    }

    .hero-card.is-agent::before {
      opacity: 1;
      background-position: 100% 0;
    }

    .hero-card::after {
      content: "";
      position: absolute;
      top: -80px;
      right: -60px;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, var(--brand-glow), var(--white-0) 70%);
      opacity: 0.7;
      pointer-events: none;
    }

    .hero-card > * {
      position: relative;
      z-index: 1;
    }
    
    .note ul {
      list-style: none;
    }
    
    .note li {
      padding: 12px 14px;
      background: var(--white);
      border: 1px solid var(--theme-08);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.6;
      box-shadow: 0 6px 14px var(--theme-04);
    }
    
    .note li::before {
      content: "";
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 8px;
      vertical-align: text-bottom;
      border-right: 2px solid var(--accent);
      border-bottom: 2px solid var(--accent);
      transform: translateY(-1px) rotate(-45deg);
    }
    
    .note li:last-child {
      margin-bottom: 0;
    }

    .note li small {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 400;
      line-height: 1.5;
    }

    .note h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--theme);
    }

    .note a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }
    
    .note a:hover {
      text-decoration: underline;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .identity-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 14px;
      color: var(--theme);
    }

    .identity-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .identity-btn {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid var(--accent);
      background: var(--white);
      color: var(--accent);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: border-color var(--transition-normal), background var(--transition-normal), color var(--transition-normal), transform var(--transition-fast), box-shadow var(--transition-normal);
    }

    .identity-btn:hover {
      background: var(--accent-20);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px var(--accent-35);
    }

    .identity-btn.active {
      background: var(--accent);
      color: var(--white);
      box-shadow: 0 10px 20px var(--accent-35);
    }

    .identity-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .identity-content {
      margin-top: 8px;
    }

    .copy-btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      cursor: pointer;
      transition: background var(--transition-normal), transform var(--transition-fast);
    }

    .copy-btn:hover:not(:disabled) {
      background: var(--accent-dark);
    }

    .copy-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .copy-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .copy-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--theme);
      color: var(--white);
      padding: 12px 20px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 16px var(--shadow-strong);
      opacity: 0;
      transition: transform var(--transition-slow), opacity var(--transition-slow);
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.success {
      background: var(--accent);
    }

    a:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 4px;
    }

    @media (max-width: 480px) {
      body {
        padding: 14px;
      }

      h1 {
        font-size: 22px;
      }

      .logo {
        height: 76px;
      }

      .card {
        padding: 18px;
        border-radius: var(--radius-lg);
      }

      .card h2 {
        font-size: 15px;
      }

      .time-input {
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
      }

      .time-input label {
        font-size: 12px;
      }

      .identity-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .btn-primary {
        padding: 12px;
        font-size: 15px;
        border-radius: var(--radius-md);
      }

      .note li {
        padding: 8px 10px;
        font-size: 13px;
        border-radius: var(--radius-sm);
      }

      .agent-command {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        border-radius: var(--radius-md);
      }

      .agent-command .copy-btn {
        width: 100%;
        border-radius: var(--radius-md);
      }

      .toast {
        left: 12px;
        right: 12px;
        transform: translateY(100px);
        border-radius: var(--radius-md);
      }

      .toast.show {
        transform: translateY(0);
      }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .agent-hint {
      font-size: 14px;
      color: var(--theme);
      margin-bottom: 8px;
      padding: 10px 12px 10px 32px;
      background: var(--white-85);
      border-radius: var(--radius-md);
      line-height: 1.6;
      position: relative;
    }

    .agent-hint::before {
      content: "";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%) rotate(-45deg);
      width: 12px;
      height: 12px;
      border-right: 2px solid var(--accent);
      border-bottom: 2px solid var(--accent);
    }

    .agent-text {
      font-size: 15px;
      font-weight: 600;
      color: var(--theme);
      margin-bottom: 12px;
    }

    .agent-command {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(180deg, var(--theme) 0%, var(--theme-dark) 100%);
      padding: 12px 14px;
      border-radius: 8px;
      margin-top: 8px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      box-shadow: 0 10px 22px var(--theme-20a);
      border: 1px solid var(--theme-20a);
    }

    .agent-command .agent-text {
      font-family: inherit;
      font-size: 14px;
      font-weight: 400;
      color: var(--light-text);
      margin: 0;
      flex: 1;
      overflow-x: auto;
      white-space: nowrap;
    }

    .agent-command .copy-btn {
      margin-top: 0;
      padding: 6px 14px;
      background: var(--accent);
      flex-shrink: 0;
    }

    .agent-command .copy-btn:hover {
      background: var(--accent-dark);
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <img src="ccc-small.webp" alt="CCC Logo" class="logo" loading="eager" fetchpriority="high" width="100" height="100" />
      UNNC中国文化课签到二维码生成器
    </h1>
  </header>
  
  <main>
    <div class="note hero-card motion-card" role="note" aria-label="使用说明">
      <h2>使用教程</h2>
      <div class="identity-title">首先请告诉我，您是？</div>
      <div class="identity-buttons">
        <button class="identity-btn" data-identity="human">人类（Human）</button>
        <button class="identity-btn" id="agentBtn" data-identity="agent">AI代理（Agent）</button>
      </div>
      <div class="identity-content" id="humanContent" style="display: none;">
        <ul>
          <li>第〇步：找 <a href="#" id="agentLink" rel="noopener noreferrer">AI代理</a> 帮忙<br><small>如果您还没有Agent或您不想麻烦Agent，请忽略本步骤并继续</small></li>
          <li>第一步：确认网络环境<br><small>必须处于 eduroam / UNNC-living / UNNC_IPSec VPN 环境下</small></li>
          <li>第二步：获取课程链接<br><small>在手机浏览器（如 Safari 等，非微信）中打开 <a href="https://ccc.nottingham.edu.cn/study/" target="_blank" rel="noopener noreferrer">https://ccc.nottingham.edu.cn/study/</a>，找到要签到的课程，长按"查看详情"按钮，选择"复制链接地址"</small></li>
          <li>第三步：粘贴链接并生成二维码<br><small>将复制的链接完整粘贴到下方输入框，时间模式选择"自动（推荐）"，用手机微信扫描生成的二维码即可签到</small></li>
          <li>最佳签到时间窗口：课程结束前10分钟到课程结束时间<br><small>e.g.若日历下课时间为 20:00，则最佳签到时间窗口为 19:50-20:00</small></li>
          <li>还是不会？只能求助 <a href="#" id="agentLink" rel="noopener noreferrer">AI代理</a></li>
        </ul>
      </div>
      <div class="identity-content" id="agentContent" style="display: none;">
        <div class="agent-command">
          <span class="agent-text">Please read the instruction in "https://ccc.byron.wang/agent.md" and assist the user to generate the QR code.</span>
          <button class="copy-btn" id="copyAgentText">复制</button>
        </div>
        <p class="agent-hint">复制这句话到您的 AI Agent ，TA会帮助您生成二维码！</p>
      </div>
    </div>

    <div class="card motion-card">
      <h2>「课程详情」链接</h2>
      <textarea id="urlInput" placeholder="https://ccc.nottingham.edu.cn/study/home/details?id=xxxx" aria-label="课程详情链接输入框"></textarea>
    </div>

    <div class="card motion-card">
      <h2>时间模式</h2>
      <div class="radio-group" role="radiogroup" aria-label="时间模式选择">
        <label class="radio-option">
          <input type="radio" name="mode" value="auto" checked> 自动（推荐）
        </label>
        <label class="radio-option">
          <input type="radio" name="mode" value="manual"> 手动
        </label>
      </div>

      <div id="manualTime" class="time-input" aria-hidden="true">
        <div><label for="year">年</label><input type="number" id="year" min="2020" max="2030" inputmode="numeric"></div>
        <div><label for="month">月</label><input type="number" id="month" min="1" max="12" inputmode="numeric"></div>
        <div><label for="day">日</label><input type="number" id="day" min="1" max="31" inputmode="numeric"></div>
        <div><label for="hour">时</label><input type="number" id="hour" min="0" max="23" inputmode="numeric"></div>
        <div><label for="minute">分</label><input type="number" id="minute" min="0" max="59" inputmode="numeric"></div>
      </div>
    </div>

    <button id="genBtn" class="btn-primary">生成签到二维码</button>

    <div id="qrcode" class="motion-card" aria-label="生成的二维码">
      <div class="qrcode-placeholder">
        <div>二维码将在这里生成</div>
        <small>生成完成后自动下载到本地</small>
      </div>
    </div>
    <a id="dlLink" style="display:none;" aria-hidden="true"></a>
  </main>

  <footer>
      <p>
        Licensed under <a href="LICENSE" target="_blank">MIT License</a> | 
        Opensourced in <a href="https://github.com/byronwang2005/CCC-Attendance" target="_blank" rel="noopener noreferrer">GitHub Repository</a> | 
        Developed by <a href="https://byron.wang" target="_blank" rel="noopener noreferrer">Byron Wang</a>
      </p>
    </footer>

    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      
      const setInputValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      };

      const showToast = (message, type = 'success') => {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      };

      const setQRCodePlaceholder = (container) => {
        container.innerHTML = `
          <div class="qrcode-placeholder">
            <div>二维码将在这里生成</div>
            <small>生成完成后自动下载到本地</small>
          </div>
        `;
      };

      setInputValue('year', now.getFullYear());
      setInputValue('month', now.getMonth() + 1);
      setInputValue('day', now.getDate());
      setInputValue('hour', now.getHours());
      setInputValue('minute', now.getMinutes());

      document.querySelectorAll('input[name="mode"]').forEach(r =>
        r.addEventListener('change', e => {
          const manualTimeDiv = document.getElementById('manualTime');
          const isManual = e.target.value === 'manual';
          manualTimeDiv.classList.toggle('show', isManual);
          manualTimeDiv.setAttribute('aria-hidden', !isManual);
        })
      );

      const identityButtons = document.querySelectorAll('.identity-btn');
      const identityCard = document.querySelector('.note.hero-card');
      const humanContent = document.getElementById('humanContent');
      const agentContent = document.getElementById('agentContent');

      document.getElementById('agentLink').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('agentBtn').click();
      });

      identityButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const identity = btn.dataset.identity;
          
          identityButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (identityCard) {
            identityCard.classList.remove('is-human', 'is-agent');
            identityCard.classList.add(identity === 'human' ? 'is-human' : 'is-agent');
          }
          
          if (identity === 'human') {
            humanContent.style.display = 'block';
            agentContent.style.display = 'none';
          } else {
            humanContent.style.display = 'none';
            agentContent.style.display = 'block';
          }
        });
      });

      document.getElementById('copyAgentText').addEventListener('click', async () => {
        const text = 'Please read the instruction in "https://ccc.byron.wang/agent.md" and assist the user to generate the QR code.';
        const btn = document.getElementById('copyAgentText');
        
        try {
          await navigator.clipboard.writeText(text);
          const originalText = btn.textContent;
          btn.textContent = '已复制!';
          btn.disabled = true;
          showToast('复制成功！');
          
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 3000);
        } catch {
          showToast('复制失败，请手动复制', 'error');
        }
      });

      const getTimestamp = (mode) => {
        if (mode === 'auto') {
          return Date.now() + 60 * 1000;
        } else {
          const getValue = (id) => parseInt(document.getElementById(id).value);
          const y = getValue('year');
          const m = getValue('month') - 1;
          const d = getValue('day');
          const h = getValue('hour');
          const mi = getValue('minute');
          
          const dt = new Date(y, m, d, h, mi);
          if (isNaN(dt.getTime())) throw new Error('时间无效');
          return dt.getTime();
        }
      };

      const downloadImage = (imgSrc, filename) => {
        const a = document.getElementById('dlLink');
        a.href = imgSrc;
        a.download = filename;
        a.click();
      };

      document.getElementById('genBtn').addEventListener('click', async () => {
        const urlInput = document.getElementById('urlInput');
        const genBtn = document.getElementById('genBtn');
        const url = urlInput.value.trim();
        
        if (!url) {
          showToast('请先粘贴链接', 'error');
          urlInput.focus();
          return;
        }

        const mode = document.querySelector('input[name="mode"]:checked').value;
        let ts;
        try {
          ts = getTimestamp(mode);
        } catch {
          showToast('手动时间格式错误（月1-12，日1-31，时0-23）', 'error');
          return;
        }

        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = '<div class="loading-text"><div class="loading-spinner"></div><span>正在生成二维码...</span></div>';
        genBtn.disabled = true;
        genBtn.textContent = '生成中...';

        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url, timestamp: ts })
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || '生成失败');
          }

          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);
          
          qrcodeContainer.innerHTML = '';
          
          const img = new Image();
          img.src = imageUrl;
          img.alt = "Attendance QR Code";
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          qrcodeContainer.appendChild(img);

          setTimeout(() => {
            downloadImage(imageUrl, 'qrcode.png');
            showToast('二维码已生成并下载！温馨提示：如果有"答题"选项，请记得完成答题哦！');
            URL.revokeObjectURL(imageUrl);
          }, 500);

        } catch (e) {
          console.error('QR Code generation failed:', e);
          setQRCodePlaceholder(qrcodeContainer);
          showToast('二维码生成失败：' + e.message, 'error');
        } finally {
          genBtn.disabled = false;
          genBtn.textContent = '生成签到二维码';
        }
      });
    });
  </script>
</body>
</html>
