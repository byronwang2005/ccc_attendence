<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="UNNC中国文化课签到二维码生成器 - 快速生成签到二维码">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content="#10263B">
  <meta http-equiv="Cache-Control" content="max-age=31536000, public">
  <title>UNNC中国文化课签到二维码生成器</title>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preload" href="ccc.webp" as="image" type="image/webp">
  <link rel="icon" type="image/svg" href="favicon.svg">
  <style>
    :root {
      --theme: #10263B;
      --theme-dark: #0d1f2f;
      --accent: #37B4B0;
      --accent-dark: #2a9a96;
      --bg-offwhite: #faf6ef;
      --theme-20: #cfd4d8;
      --accent-20: #d7f0ef;
      --white: #ffffff;
      --white-60: rgba(255, 255, 255, 0.6);
      --dark-bg: #10263B;
      --light-text: #d7f0ef;
      --text-muted: #cfd4d8;
      --text-secondary: #5a6b7a;
      --shadow: rgba(16, 38, 59, 0.06);
      --shadow-strong: rgba(16, 38, 59, 0.1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-offwhite);
      color: var(--theme);
      padding: 16px;
      max-width: 640px;
      margin: 0 auto;
      min-height: 100vh;
    }
    
    header {
      text-align: center;
      margin: 24px 0 16px;
    }

    h1 {
      font-weight: 700;
      font-size: 24px;
      color: var(--theme);
    }

    h1 .logo {
      vertical-align: middle;
    }

    .logo {
      height: 100px;
      width: auto;
    }

    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--theme-20);
    }
    
    .card h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--theme);
    }
    
    textarea, input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--theme-20);
      border-radius: 8px;
      font-size: 15px;
      background: var(--white);
      resize: none;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    textarea:focus, input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-20);
    }
    
    textarea { min-height: 60px; }
    
    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    
    .radio-option input {
      width: auto;
      accent-color: var(--accent);
      cursor: pointer;
    }
    
    .time-input {
      display: none;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .time-input.show {
      display: grid;
    }
    
    .time-input label {
      font-size: 13px;
      color: var(--theme-20);
      text-align: center;
      display: block;
      margin-bottom: 4px;
    }
    
    .time-input input {
      text-align: center;
      padding: 10px 0;
    }
    
    .btn-primary {
      background: var(--theme);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
      transition: background 0.2s, transform 0.1s;
    }
    
    .btn-primary:hover {
      background: var(--theme-dark);
    }
    
    .btn-primary:active {
      transform: scale(0.99);
    }
    
    #qrcode {
      display: flex;
      justify-content: center;
      margin: 24px 0 16px;
    }
    
    #qrcode canvas {
      background: var(--theme);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px var(--shadow-strong);
    }
    
    .note {
      background: var(--accent-20);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 16px;
      font-size: 14px;
      color: var(--theme);
      line-height: 1.5;
    }
    
    .note ul {
      list-style: none;
    }
    
    .note li {
      padding: 8px 12px;
      background: var(--white-60);
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .note li::before {
      content: "→";
      margin-right: 8px;
      color: var(--accent);
      font-weight: 600;
    }
    
    .note li:last-child {
      margin-bottom: 0;
    }

    .note li small {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 400;
      line-height: 1.5;
    }

    .note h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--theme);
    }

    .note a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }
    
    .note a:hover {
      text-decoration: underline;
    }

    footer {
      text-align: center;
      margin-top: 32px;
      padding-bottom: 16px;
      font-size: 13px;
      color: var(--theme-20);
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .identity-title {
      font-size: 14px;
      font-weight: 400;
      margin-bottom: 12px;
      color: var(--theme);
    }

    .identity-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .identity-btn {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid var(--accent);
      background: var(--white);
      color: var(--accent);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .identity-btn:hover {
      background: var(--accent-20);
    }

    .identity-btn.active {
      background: var(--accent);
      color: var(--white);
    }

    .identity-content {
      margin-top: 8px;
    }

    .copy-btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: var(--accent-dark);
    }

    .copy-btn:active {
      transform: scale(0.98);
    }

    .agent-hint {
      font-size: 14px;
      color: var(--theme);
      margin-bottom: 8px;
      padding: 8px 12px;
      background: var(--white-60);
      border-radius: 6px;
      line-height: 1.6;
    }

    .agent-hint::before {
      content: "→";
      margin-right: 8px;
      color: var(--accent);
      font-weight: 600;
    }

    .agent-text {
      font-size: 15px;
      font-weight: 600;
      color: var(--theme);
      margin-bottom: 12px;
    }

    .agent-command {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--theme);
      padding: 12px 14px;
      border-radius: 8px;
      margin-top: 8px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    .agent-command .agent-text {
      font-family: inherit;
      font-size: 14px;
      font-weight: 400;
      color: var(--light-text);
      margin: 0;
      flex: 1;
      overflow-x: auto;
      white-space: nowrap;
    }

    .agent-command .copy-btn {
      margin-top: 0;
      padding: 6px 14px;
      background: var(--accent);
      flex-shrink: 0;
    }

    .agent-command .copy-btn:hover {
      background: var(--accent-dark);
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <img src="ccc.webp" alt="CCC Logo" class="logo" loading="lazy" fetchpriority="high" width="100" height="100" />
      UNNC中国文化课签到二维码生成器
    </h1>
  </header>
  
  <main>
    <div class="note" role="note" aria-label="使用说明">
      <h2>使用教程</h2>
      <div class="identity-title">首先请告诉我，您是？</div>
      <div class="identity-buttons">
        <button class="identity-btn" data-identity="human">人类（Human）</button>
        <button class="identity-btn" id="agentBtn" data-identity="agent">AI代理（Agent）</button>
      </div>
      <div class="identity-content" id="humanContent" style="display: none;">
        <ul>
          <li>第零步：找AI代理帮忙<br><small>如果您还没有Agent或您不想麻烦Agent，请忽略本步骤并继续</small></li>
          <li>第一步：确认网络环境<br><small>必须处于 eduroam / UNNC-living / UNNC_IPSec VPN 环境下</small></li>
          <li>第二步：获取课程链接<br><small>在手机浏览器（如 Safari 等，非微信）中打开 <a href="https://ccc.nottingham.edu.cn/study/" target="_blank" rel="noopener noreferrer">https://ccc.nottingham.edu.cn/study/</a>，找到要签到的课程，长按"查看详情"按钮，选择"复制链接地址"</small></li>
          <li>第三步：粘贴链接并生成二维码<br><small>将复制的链接完整粘贴到下方输入框，时间模式选择"自动（推荐）"，用手机微信扫描生成的二维码即可签到</small></li>
          <li>最佳签到时间窗口：课程结束前 10 分钟到课程结束时间<br><small>e.g.若日历下课时间为 20:00，则最佳签到时间窗口为 19:50-20:00</small></li>
          <li>还是不会？只能求助 <a href="#" id="agentLink" rel="noopener noreferrer">AI代理</a></li>
        </ul>
      </div>
      <div class="identity-content" id="agentContent" style="display: none;">
        <div class="agent-command">
          <span class="agent-text">Please read the instruction in "https://ccc.byron.wang/agent.md" and assist the user to generate the QR code.</span>
          <button class="copy-btn" id="copyAgentText">复制</button>
        </div>
        <p class="agent-hint">复制这句话到您的 AI Agent，TA会帮助您生成二维码！</p>
      </div>
    </div>

    <div class="card">
      <h2>“课程详情”链接</h2>
      <textarea id="urlInput" placeholder="https://ccc.nottingham.edu.cn/study/home/details?id=xxxx" aria-label="课程详情链接输入框"></textarea>
    </div>

    <div class="card">
      <h2>时间模式</h2>
      <div class="radio-group" role="radiogroup" aria-label="时间模式选择">
        <label class="radio-option">
          <input type="radio" name="mode" value="auto" checked> 自动（推荐）
        </label>
        <label class="radio-option">
          <input type="radio" name="mode" value="manual"> 手动
        </label>
      </div>

      <div id="manualTime" class="time-input" aria-hidden="true">
        <div><label for="year">年</label><input type="number" id="year" min="2020" max="2030"></div>
        <div><label for="month">月</label><input type="number" id="month" min="1" max="12"></div>
        <div><label for="day">日</label><input type="number" id="day" min="1" max="31"></div>
        <div><label for="hour">时</label><input type="number" id="hour" min="0" max="23"></div>
        <div><label for="minute">分</label><input type="number" id="minute" min="0" max="59"></div>
      </div>
    </div>

    <button id="genBtn" class="btn-primary">生成签到二维码</button>

    <div id="qrcode" aria-label="生成的二维码"></div>
    <a id="dlLink" style="display:none;" aria-hidden="true"></a>
  </main>

  <footer>
    <p>
      Licensed under <a href="LICENSE" target="_blank">MIT License</a> | 
      Opensourced in <a href="https://github.com/byronwang2005/CCC-Attendance-QRcode-Generator" target="_blank" rel="noopener noreferrer">GitHub Repository</a> | 
      Developed by <a href="https://byron.wang" target="_blank" rel="noopener noreferrer">Byron Wang</a>
    </p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      
      const setInputValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      };

      setInputValue('year', now.getFullYear());
      setInputValue('month', now.getMonth() + 1);
      setInputValue('day', now.getDate());
      setInputValue('hour', now.getHours());
      setInputValue('minute', now.getMinutes());

      document.querySelectorAll('input[name="mode"]').forEach(r =>
        r.addEventListener('change', e => {
          const manualTimeDiv = document.getElementById('manualTime');
          const isManual = e.target.value === 'manual';
          manualTimeDiv.classList.toggle('show', isManual);
          manualTimeDiv.setAttribute('aria-hidden', !isManual);
        })
      );

      const identityButtons = document.querySelectorAll('.identity-btn');
      const humanContent = document.getElementById('humanContent');
      const agentContent = document.getElementById('agentContent');

      document.getElementById('agentLink').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('agentBtn').click();
      });

      identityButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const identity = btn.dataset.identity;
          
          identityButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          if (identity === 'human') {
            humanContent.style.display = 'block';
            agentContent.style.display = 'none';
          } else {
            humanContent.style.display = 'none';
            agentContent.style.display = 'block';
          }
        });
      });

      document.getElementById('copyAgentText').addEventListener('click', () => {
        const text = 'Read the instruction in "https://ccc.byron.wang/agent.md"';
        navigator.clipboard.writeText(text).then(() => {
          const btn = document.getElementById('copyAgentText');
          const originalText = btn.textContent;
          btn.textContent = '已复制!';
          btn.style.background = 'var(--accent-dark)';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
          }, 2000);
        }).catch(() => {
          alert('复制失败，请手动复制');
        });
      });

      const getTimestamp = (mode) => {
        if (mode === 'auto') {
          return Date.now() + 60 * 1000;
        } else {
          const getValue = (id) => parseInt(document.getElementById(id).value);
          const y = getValue('year');
          const m = getValue('month') - 1;
          const d = getValue('day');
          const h = getValue('hour');
          const mi = getValue('minute');
          
          const dt = new Date(y, m, d, h, mi);
          if (isNaN(dt.getTime())) throw new Error('时间无效');
          return dt.getTime();
        }
      };

      const downloadImage = (imgSrc, filename) => {
        const a = document.getElementById('dlLink');
        a.href = imgSrc;
        a.download = filename;
        a.click();
      };

      document.getElementById('genBtn').addEventListener('click', async () => {
        const urlInput = document.getElementById('urlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
          alert('请先粘贴链接');
          urlInput.focus();
          return;
        }

        const mode = document.querySelector('input[name="mode"]:checked').value;
        let ts;
        try {
          ts = getTimestamp(mode);
        } catch (e) {
          return alert('手动时间格式错误（月1-12，日1-31，时0-23）');
        }

        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = '<p>正在生成...</p>';

        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url, timestamp: ts })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || '生成失败');
          }

          const qrBase64 = data.qrCodeBase64;
          qrcodeContainer.innerHTML = '';
          
          const img = new Image();
          img.src = qrBase64;
          img.alt = "Attendance QR Code";
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          qrcodeContainer.appendChild(img);

          // Auto download after a short delay
          setTimeout(() => {
            downloadImage(qrBase64, 'qrcode.png');
            alert('温馨提示：如果有"答题"选项，请记得完成答题哦！');
          }, 500);

        } catch (e) {
          console.error('QR Code generation failed:', e);
          qrcodeContainer.innerHTML = ''; // Clear "generating..." text
          alert('二维码生成失败：' + e.message);
        }
      });
    });
  </script>
</body>
</html>
